<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>æ–°å‹æ™ºèƒ½è´­ç‰©è½¦</title>
	<link rel="stylesheet" href="css/bootstrap.min.css">
	<link rel="stylesheet" href="css/style.css">
	<link rel="icon" href="img/favicon.ico">
</head>

<body>
	<div class="trolley">
		<nav class="navbar navbar-expand-lg bg-light">
			<div class="container-fluid">
				<h3> ğŸ›’ æ–°å‹æ™ºèƒ½è´­ç‰©è½¦ </h3>

				<span id="fullscreen">ğŸ”</span>
			</div>
		</nav>

		<div class="container text-center main">
			<div class="row align-items-start">
				<div class="col-4 scan-area">
					<div id="loadingMessage">ğŸ¥ è¿˜æœªæ‰“å¼€æ‘„åƒå¤´</div>
					<canvas id="canvas" hidden></canvas>
				</div>

				<div class="col-8 good-area">
					<div class="row" id="goods">
					</div>
				</div>
			</div>
		</div>


		<!-- ç»“è´¦ -->
		<div class="check">
			<div class=" row justify-content-around">
				<div class="total_money col-5" id="total_money">
					ï¿¥ 0
				</div>
				<button type="button" class="btn btn-lg btn-warning col-5">
					ç»“è´¦
				</button>
			</div>
		</div>
	</div>


	<script src="js/bootstrap.bundle.min.js"></script>
	<script src="js/jquery-3.6.1.min.js"></script>
	<script src="js/jsQR.js"></script>

	<script>
		let goods_div = $("#goods")

		let goods = []

		let total_money = 0

		let add_good_to_trolley = (item) => {
			let item_div = `<div class="card col-5">
                        <div class= "card-body">
                            <h5 class="card-title">${item.name}</h5>
                            <div class="row">
                                <p class="col-6 price">ï¿¥ ${item.price}</p>
                                <div class="col-6">
                                    <button type="button" class="btn btn-danger delete"> åˆ é™¤ </button>
                                </div>
                            </div>
                        </div >
                    </div >`
			goods_div.append($(item_div))
			total_money += parseFloat(item.price)
			$("#total_money").text(`ï¿¥ ${total_money}`)
		}

		for (item of goods) {
			add_good_to_trolley(item)
		}

		$(".good-area").on("click", ".delete", ((e) => {
			let index = $(".delete").index(e.target);
			let item = goods[index]

			total_money -= parseFloat(item.price)
			goods.splice(index, 1)

			$(".card").eq(index).remove()
			$("#total_money").text(`ï¿¥ ${total_money}`)
		}))

		var video = document.createElement("video");
		var canvasElement = document.getElementById("canvas");
		var canvas = canvasElement.getContext("2d");

		// Use facingMode: environment to attemt to get the front camera on phones
		navigator.mediaDevices.getUserMedia({
			video: {
				facingMode: "environment"
			}
		}).then(function (stream) {
			video.srcObject = stream;
			video.setAttribute("playsinline", true); // required to tell iOS safari we don't want fullscreen
			video.play();
			requestAnimationFrame(tick);
		});

		function debounce(fn, wait) {
			var timer = null;
			return function () {
				if (timer !== null) {
					clearTimeout(timer);
				}
				timer = setTimeout(fn, wait);
			}
		}

		function drawLine(begin, end, color) {
			canvas.beginPath();
			canvas.moveTo(begin.x, begin.y);
			canvas.lineTo(end.x, end.y);
			canvas.lineWidth = 4;
			canvas.strokeStyle = color;
			canvas.stroke();
		}

		let scanned_item = false

		function tick() {
			if (video.readyState === video.HAVE_ENOUGH_DATA) {
				loadingMessage.hidden = true;
				canvasElement.hidden = false;

				canvasElement.height = video.videoHeight;
				canvasElement.width = video.videoWidth;
				canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
				var imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
				var code = jsQR(imageData.data, imageData.width, imageData.height, {
					inversionAttempts: "dontInvert",
				});

				if (code) {
					// æ ‡è®°å‡ºäºŒç»´ç 
					drawLine(code.location.topLeftCorner, code.location.topRightCorner, "#FF3B58");
					drawLine(code.location.topRightCorner, code.location.bottomRightCorner, "#FF3B58");
					drawLine(code.location.bottomRightCorner, code.location.bottomLeftCorner, "#FF3B58");
					drawLine(code.location.bottomLeftCorner, code.location.topLeftCorner, "#FF3B58");

					if (!scanned_item) {
						console.log(code.data)

						// æ·»åŠ å•†å“
						let item_info = code.data.split("_") // å°éº¦é¢ç²‰_20
						if (item_info.length == 2) {
							let item = {
								name: item_info[0],
								price: item_info[1]
							}

							goods.push(item)
							add_good_to_trolley(item)

							scanned_item = true
						}
					}
				} else {
					scanned_item = false
				}
			}
			requestAnimationFrame(tick)
		}

		// å…¨å±
		function requestFullScreen(element) {
			var requestMethod = element.requestFullScreen || element.webkitRequestFullScreen || element.mozRequestFullScreen || element.msRequestFullScreen;
			if (requestMethod) {
				requestMethod.call(element);
			} else if (typeof window.ActiveXObject !== "undefined") {
				var wscript = new ActiveXObject("WScript.Shell");
				if (wscript !== null) {
					wscript.SendKeys("{F11}");
				}
			}
		}

		$("#fullscreen").click(() => {
			requestFullScreen(document.documentElement)
		})
	</script>

</body>

</html>